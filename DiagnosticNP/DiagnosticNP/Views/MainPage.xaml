<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:syncfusion="clr-namespace:Syncfusion.XForms.TreeView;assembly=Syncfusion.SfTreeView.XForms"
             xmlns:viewmodels="clr-namespace:DiagnosticNP.ViewModels"
             x:Class="DiagnosticNP.Views.MainPage"
             Title="Вибродиагностика">

    <ContentPage.BindingContext>
        <viewmodels:MainViewModel />
    </ContentPage.BindingContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Панель управления -->
        <StackLayout Grid.Row="0" Padding="10" BackgroundColor="#f0f0f0">
            <Label Text="NFC фильтр:" FontAttributes="Bold"/>
            <Label Text="{Binding NfcFilter}" 
                   BackgroundColor="LightBlue" 
                   Padding="10"
                   Margin="0,5,0,10"/>

            <Button Text="Загрузить контрольные точки" 
                    Command="{Binding LoadControlPointsCommand}"
                    BackgroundColor="#2196F3"
                    TextColor="White"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}"/>

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" 
                        Text="Выгрузить замеры" 
                        Command="{Binding UploadMeasurementsCommand}"
                        BackgroundColor="#4CAF50"
                        TextColor="White"
                        Margin="0,5,5,0"/>

                <Button Grid.Column="1" 
                        Text="Очистить замеры" 
                        Command="{Binding ClearMeasurementsCommand}"
                        BackgroundColor="#F44336"
                        TextColor="White"
                        Margin="5,5,0,0"/>
            </Grid>
        </StackLayout>

        <!-- Дерево контрольных точек -->
        <syncfusion:SfTreeView Grid.Row="1"
                               x:Name="TreeView"
                               ItemsSource="{Binding ControlPoints}"
                               NotificationSubscriptionMode="CollectionChange"
                               ChildPropertyName="Children"
                               AutoExpandMode="AllNodesExpanded"
                               SelectionMode="Single"
                               SelectedItem="{Binding SelectedControlPoint}">

            <syncfusion:SfTreeView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Label Grid.Column="0" 
                               Text="{Binding Name}" 
                               VerticalOptions="Center"
                               FontSize="14"/>

                        <Button Grid.Column="1"
                                Text="Замер"
                                BackgroundColor="#FF9800"
                                TextColor="White"
                                FontSize="12"
                                Padding="10,5"
                                IsVisible="{Binding HasMeasurements}"
                                Command="{Binding BindingContext.TakeMeasurementCommand, Source={x:Reference TreeView}}"
                                CommandParameter="{Binding .}"/>
                    </Grid>
                </DataTemplate>
            </syncfusion:SfTreeView.ItemTemplate>
        </syncfusion:SfTreeView>

        <!-- Список замеров -->
        <StackLayout Grid.Row="2" Padding="10" BackgroundColor="#e0e0e0">
            <Label Text="Локальные замеры:" FontAttributes="Bold"/>
            <ListView ItemsSource="{Binding Measurements}" 
                      HeightRequest="120"
                      HasUnevenRows="True">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <ViewCell>
                            <Grid Padding="5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackLayout Grid.Column="0">
                                    <Label Text="{Binding ControlPointPath}" FontSize="12"/>
                                    <Label Text="{Binding MeasurementTime, StringFormat='{0:dd.MM.yyyy HH:mm}'}" 
                                           FontSize="10" 
                                           TextColor="Gray"/>
                                </StackLayout>

                                <Label Grid.Column="1" 
                                       Text="{Binding Velocity, StringFormat='{0} мм/с'}" 
                                       FontSize="12"
                                       FontAttributes="Bold"/>
                            </Grid>
                        </ViewCell>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </StackLayout>

        <!-- Индикатор загрузки -->
        <ActivityIndicator Grid.RowSpan="3" 
                           IsVisible="{Binding IsBusy}"
                           IsRunning="{Binding IsBusy}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           Color="#2196F3"/>
    </Grid>
</ContentPage>
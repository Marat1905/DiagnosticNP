<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:sfTreeView="clr-namespace:Syncfusion.XForms.TreeView;assembly=Syncfusion.SfTreeView.XForms"
             xmlns:viewModels="clr-namespace:DiagnosticNP.ViewModels"
             x:Class="DiagnosticNP.Views.MainPage"
             Title="Вибродиагностика">

    <ContentPage.BindingContext>
        <viewModels:MainViewModel />
    </ContentPage.BindingContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- NFC Filter Info -->
        <Frame Grid.Row="0" BackgroundColor="LightBlue" Margin="10" IsVisible="{Binding NfcFilter, Converter={StaticResource StringToVisibilityConverter}}">
            <StackLayout Orientation="Horizontal">
                <Label Text="NFC фильтр:" FontAttributes="Bold"/>
                <Label Text="{Binding NfcFilter}" Margin="10,0,0,0"/>
            </StackLayout>
        </Frame>

        <!-- TreeView -->
        <sfTreeView:SfTreeView Grid.Row="1" 
                               ItemsSource="{Binding FilteredNodes}"
                               NotificationSubscriptionMode="CollectionChange"
                               ChildPropertyName="Children"
                               AutoExpandMode="AllNodesExpanded"
                               SelectedItem="{Binding SelectedNode}">

            <sfTreeView:SfTreeView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="10,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Label Grid.Column="0" Text="{Binding Name}" VerticalOptions="Center"/>

                        <Label Grid.Column="1" Text="➡" 
                               IsVisible="{Binding Type, Converter={StaticResource DirectionTypeConverter}}"
                               TextColor="Green" FontSize="16"
                               VerticalOptions="Center"/>
                    </Grid>
                </DataTemplate>
            </sfTreeView:SfTreeView.ItemTemplate>
        </sfTreeView:SfTreeView>

        <!-- Buttons -->
        <StackLayout Grid.Row="2" Orientation="Horizontal" HorizontalOptions="Center" Spacing="10" Margin="10">
            <Button Text="Загрузить данные" 
                    Command="{Binding LoadControlPointsCommand}"
                    IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                    BackgroundColor="RoyalBlue"
                    TextColor="White"/>

            <Button Text="Выгрузить" 
                    Command="{Binding UploadDataCommand}"
                    IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                    BackgroundColor="Green"
                    TextColor="White"/>

            <Button Text="Очистить" 
                    Command="{Binding ClearDataCommand}"
                    IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                    BackgroundColor="Red"
                    TextColor="White"/>
        </StackLayout>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1" Grid.RowSpan="3" 
                          IsVisible="{Binding IsLoading}"
                          IsRunning="{Binding IsLoading}"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"/>
    </Grid>
</ContentPage>
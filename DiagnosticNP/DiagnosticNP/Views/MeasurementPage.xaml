<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:DiagnosticNP.Converters;assembly=DiagnosticNP"
             x:Class="DiagnosticNP.Views.MeasurementPage"
             Title="Новый замер">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
            <converters:DoubleConverter x:Key="DoubleConverter"/>
            <converters:PollingStateToColorConverter x:Key="PollingStateToColorConverter"/>
            <converters:PollingStateToTextConverter x:Key="PollingStateToTextConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Padding="20" Spacing="15">

            <!-- Информация о точке замера -->
            <Frame BackgroundColor="LightBlue" Padding="10">
                <StackLayout>
                    <Label Text="Точка замера:" FontAttributes="Bold"/>
                    <Label Text="{Binding EquipmentPath}" 
                           FontSize="14"/>
                    <Label Text="Тип замера:" FontAttributes="Bold" Margin="0,10,0,0"/>
                    <Label Text="{Binding MeasurementType}" 
                           FontSize="14"
                           TextColor="DarkGreen"/>
                    <Label Text="Время замера:" FontAttributes="Bold" Margin="0,10,0,0"/>
                    <Label Text="{Binding MeasurementTime, StringFormat='{0:dd.MM.yyyy HH:mm:ss}'}" 
                           FontSize="14"
                           TextColor="DarkBlue"/>
                </StackLayout>
            </Frame>

            <!-- Статус виброметра -->
            <Frame BackgroundColor="LightYellow" Padding="15">
                <StackLayout>
                    <Label Text="Виброметр ViPen" FontAttributes="Bold" FontSize="16"/>
                    <Label Text="{Binding VibrometerStatus}" 
                           FontSize="14"
                           TextColor="DarkBlue"/>

                    <!-- Состояние подключения и опроса -->
                    <StackLayout Orientation="Horizontal" Spacing="10" Margin="0,5,0,0">
                        <Frame BackgroundColor="{Binding IsPollingVibrometer, Converter={StaticResource PollingStateToColorConverter}}" 
                               Padding="5,2" HasShadow="False">
                            <Label Text="{Binding IsPollingVibrometer, Converter={StaticResource PollingStateToTextConverter}}"
                                   FontSize="10" TextColor="White" HorizontalTextAlignment="Center"/>
                        </Frame>
                    </StackLayout>

                    <Label Text="Последнее обновление данных:" FontAttributes="Italic" Margin="0,10,0,0"/>
                    <Label Text="{Binding LastDataUpdate, StringFormat='{0:dd.MM.yyyy HH:mm:ss}'}" 
                           FontSize="12"
                           TextColor="Gray"/>

                    <ActivityIndicator IsVisible="{Binding IsReadingData}" 
                                     IsRunning="{Binding IsReadingData}"
                                     Color="Blue"/>
                </StackLayout>
            </Frame>

            <!-- Текущие данные виброметра -->
            <Frame BackgroundColor="White" Padding="15">
                <StackLayout>
                    <Label Text="Текущие данные" FontAttributes="Bold" FontSize="16" HorizontalOptions="Center"/>

                    <Grid Margin="0,10,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Скорость вибрации -->
                        <StackLayout Grid.Row="0" Grid.Column="0">
                            <Label Text="Скорость вибрации" FontAttributes="Bold" FontSize="12"/>
                            <Label Text="{Binding Velocity, StringFormat='{0:F2} мм/с'}" 
                                   FontSize="14" TextColor="DarkBlue" HorizontalTextAlignment="Center"/>
                        </StackLayout>

                        <!-- Температура -->
                        <StackLayout Grid.Row="0" Grid.Column="1">
                            <Label Text="Температура" FontAttributes="Bold" FontSize="12"/>
                            <Label Text="{Binding Temperature, StringFormat='{0:F1} °C'}" 
                                   FontSize="14" TextColor="DarkRed" HorizontalTextAlignment="Center"/>
                        </StackLayout>

                        <!-- Ускорение -->
                        <StackLayout Grid.Row="1" Grid.Column="0" Margin="0,10,0,0">
                            <Label Text="Ускорение" FontAttributes="Bold" FontSize="12"/>
                            <Label Text="{Binding Acceleration, StringFormat='{0:F2} м/с²'}" 
                                   FontSize="14" TextColor="DarkGreen" HorizontalTextAlignment="Center"/>
                        </StackLayout>

                        <!-- Куртозис -->
                        <StackLayout Grid.Row="1" Grid.Column="1" Margin="0,10,0,0">
                            <Label Text="Куртозис" FontAttributes="Bold" FontSize="12"/>
                            <Label Text="{Binding Kurtosis, StringFormat='{0:F2}'}" 
                                   FontSize="14" TextColor="DarkOrange" HorizontalTextAlignment="Center"/>
                        </StackLayout>
                    </Grid>
                </StackLayout>
            </Frame>

            <!-- Поля ввода данных для ручного редактирования -->
            <Frame BackgroundColor="White" Padding="15">
                <StackLayout Spacing="10">
                    <Label Text="Ручной ввод данных" FontAttributes="Bold" FontSize="14"/>

                    <!-- Скорость вибрации -->
                    <StackLayout>
                        <Label Text="Скорость вибрации (мм/с):" FontSize="12"/>
                        <Entry Keyboard="Numeric"
                               Text="{Binding Velocity, Converter={StaticResource DoubleConverter}}"
                               Placeholder="0.00"/>
                    </StackLayout>

                    <!-- Температура -->
                    <StackLayout>
                        <Label Text="Температура (°C):" FontSize="12"/>
                        <Entry Keyboard="Numeric"
                               Text="{Binding Temperature, Converter={StaticResource DoubleConverter}}"
                               Placeholder="0.0"/>
                    </StackLayout>

                    <!-- Ускорение -->
                    <StackLayout>
                        <Label Text="Ускорение (м/с²):" FontSize="12"/>
                        <Entry Keyboard="Numeric"
                               Text="{Binding Acceleration, Converter={StaticResource DoubleConverter}}"
                               Placeholder="0.00"/>
                    </StackLayout>

                    <!-- Куртозис -->
                    <StackLayout>
                        <Label Text="Куртозис:" FontSize="12"/>
                        <Entry Keyboard="Numeric"
                               Text="{Binding Kurtosis, Converter={StaticResource DoubleConverter}}"
                               Placeholder="0.00"/>
                    </StackLayout>
                </StackLayout>
            </Frame>

            <!-- Управление виброметром -->
            <StackLayout Spacing="10">
                <Label Text="Управление виброметром" FontAttributes="Bold" FontSize="14"/>

                <!-- Кнопки опроса -->
                <StackLayout Orientation="Horizontal" Spacing="10">
                    <Button Text="▶ Запуск опроса" 
                            Command="{Binding StartPollingCommand}"
                            BackgroundColor="DarkGreen"
                            TextColor="White"
                            HorizontalOptions="FillAndExpand"
                            HeightRequest="45"
                            FontSize="12"
                            IsEnabled="{Binding IsPollingVibrometer, Converter={StaticResource InverseBooleanConverter}}"/>

                    <Button Text="⏹ Остановка опроса" 
                            Command="{Binding StopPollingCommand}"
                            BackgroundColor="DarkRed"
                            TextColor="White"
                            HorizontalOptions="FillAndExpand"
                            HeightRequest="45"
                            FontSize="12"
                            IsEnabled="{Binding IsPollingVibrometer}"/>
                </StackLayout>
            </StackLayout>

            <!-- Кнопки действий -->
            <StackLayout Orientation="Horizontal" Spacing="10" Margin="0,10,0,0">
                <Button Text="Отмена" 
                        Clicked="OnCancelClicked"
                        BackgroundColor="Gray"
                        TextColor="White"
                        HorizontalOptions="FillAndExpand"
                        HeightRequest="45"/>

                <Button Text="💾 Сохранить замер" 
                        Command="{Binding SaveMeasurementCommand}"
                        BackgroundColor="DarkBlue"
                        TextColor="White"
                        HorizontalOptions="FillAndExpand"
                        HeightRequest="45"/>
            </StackLayout>

        </StackLayout>
    </ScrollView>
</ContentPage>
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="DiagnosticNP.Views.MeasurementPage"
             Title="Замер вибрации">

    <ScrollView>
        <StackLayout Padding="20" Spacing="15">

            <!-- Header -->
            <Label Text="{Binding DirectionName}" FontSize="20" FontAttributes="Bold" HorizontalOptions="Center"/>
            <Label Text="{Binding FullPath}" FontSize="12" TextColor="Gray" HorizontalOptions="Center"/>

            <!-- Connection Status -->
            <Frame BackgroundColor="{Binding ConnectionStatus, Converter={StaticResource StatusToColorConverter}}">
                <StackLayout Orientation="Horizontal" HorizontalOptions="Center">
                    <Label Text="Статус:" FontAttributes="Bold"/>
                    <Label Text="{Binding ConnectionStatus}" Margin="10,0,0,0"/>
                </StackLayout>
            </Frame>

            <!-- Measurement Form -->
            <Frame BackgroundColor="White" BorderColor="LightGray">
                <StackLayout Spacing="10">
                    <Label Text="Параметры замера:" FontAttributes="Bold"/>

                    <StackLayout Orientation="Horizontal">
                        <Label Text="Скорость вибрации:" VerticalOptions="Center"/>
                        <Entry Text="{Binding Velocity}" Keyboard="Numeric" HorizontalOptions="FillAndExpand"/>
                        <Label Text="мм/с" VerticalOptions="Center"/>
                    </StackLayout>

                    <StackLayout Orientation="Horizontal">
                        <Label Text="Температура:" VerticalOptions="Center"/>
                        <Entry Text="{Binding Temperature}" Keyboard="Numeric" HorizontalOptions="FillAndExpand"/>
                        <Label Text="°C" VerticalOptions="Center"/>
                    </StackLayout>

                    <StackLayout Orientation="Horizontal">
                        <Label Text="Ускорение:" VerticalOptions="Center"/>
                        <Entry Text="{Binding Acceleration}" Keyboard="Numeric" HorizontalOptions="FillAndExpand"/>
                        <Label Text="м/с²" VerticalOptions="Center"/>
                    </StackLayout>

                    <StackLayout Orientation="Horizontal">
                        <Label Text="Куртозис:" VerticalOptions="Center"/>
                        <Entry Text="{Binding Kurtosis}" Keyboard="Numeric" HorizontalOptions="FillAndExpand"/>
                    </StackLayout>
                </StackLayout>
            </Frame>

            <!-- Save and Clear Buttons -->
            <StackLayout Orientation="Horizontal" HorizontalOptions="Center" Spacing="10">
                <Button Text="Сохранить замер" 
                        Command="{Binding SaveMeasurementCommand}"
                        BackgroundColor="Blue"
                        TextColor="White"
                        WidthRequest="150"/>

                <Button Text="Очистить форму" 
                        Command="{Binding ClearFormCommand}"
                        BackgroundColor="Gray"
                        TextColor="White"
                        WidthRequest="150"/>
            </StackLayout>

            <!-- Vibrometer Controls -->
            <Frame BackgroundColor="LightBlue" IsVisible="{Binding CanUseVibrometer}">
                <StackLayout Spacing="10">
                    <Label Text="Виброметр ViPen:" FontAttributes="Bold" HorizontalOptions="Center"/>

                    <!-- КНОПКИ ОПРОСА -->
                    <StackLayout Orientation="Horizontal" HorizontalOptions="Center" Spacing="10">
                        <Button Text="Запуск опроса" 
                                Command="{Binding StartPollingCommand}"
                                IsEnabled="{Binding IsPolling, Converter={StaticResource InverseBooleanConverter}}"
                                BackgroundColor="DarkGreen"
                                TextColor="White"
                                WidthRequest="150"/>

                        <Button Text="Остановка опроса" 
                                Command="{Binding StopPollingCommand}"
                                IsEnabled="{Binding IsPolling}"
                                BackgroundColor="DarkRed"
                                TextColor="White"
                                WidthRequest="150"/>
                    </StackLayout>

                    <!-- Polling Indicator -->
                    <ActivityIndicator IsVisible="{Binding IsPolling}"
                                      IsRunning="{Binding IsPolling}"
                                      HorizontalOptions="Center"/>
                    <Label Text="Идет опрос виброметра..." 
                           IsVisible="{Binding IsPolling}"
                           HorizontalOptions="Center"
                           TextColor="Green"/>
                </StackLayout>
            </Frame>

            <!-- Latest Measurement -->
            <Frame BackgroundColor="LightYellow" IsVisible="{Binding LatestMeasurement.HasData}">
                <StackLayout>
                    <Label Text="Последний замер:" FontAttributes="Bold"/>
                    <Label Text="{Binding LatestMeasurement.MeasurementTime, StringFormat='Время: {0:dd.MM.yyyy HH:mm}'}"/>
                    <Label Text="{Binding LatestMeasurement.Velocity, StringFormat='Скорость: {0:F2} мм/с'}"/>
                    <Label Text="{Binding LatestMeasurement.Temperature, StringFormat='Температура: {0:F2} °C'}"/>
                    <Label Text="{Binding LatestMeasurement.Acceleration, StringFormat='Ускорение: {0:F2} м/с²'}"/>
                    <Label Text="{Binding LatestMeasurement.Kurtosis, StringFormat='Куртозис: {0:F2}'}"/>
                    <Label Text="{Binding LatestMeasurement.DeviceId, StringFormat='Устройство: {0}'}"/>
                </StackLayout>
            </Frame>
        </StackLayout>
    </ScrollView>
</ContentPage>
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="DiagnosticNP.Views.MeasurementPage"
             Title="Замер вибрации"
             BackgroundColor="{StaticResource BackgroundColor}">

    <ScrollView>
        <StackLayout Padding="20" Spacing="20">

            <!-- Header Section -->
            <Frame Style="{StaticResource CardFrame}">
                <StackLayout Spacing="8">
                    <Label Text="{Binding DirectionName}" 
                           Style="{StaticResource TitleLabel}"/>
                    <Label Text="{Binding FullPath}" 
                           Style="{StaticResource SubtitleLabel}"/>
                </StackLayout>
            </Frame>

            <!-- Status Card -->
            <Frame Style="{StaticResource CardFrame}">
                <StackLayout Spacing="10">
                    <Label Text="Статус подключения" 
                           FontAttributes="Bold" 
                           FontSize="16"
                           TextColor="{StaticResource TextPrimary}"/>

                    <Frame BackgroundColor="{Binding ConnectionStatus, Converter={StaticResource StatusToColorConverter}}"
                           CornerRadius="8" Padding="15,10" HasShadow="False">
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Label Text="📶" FontSize="16" VerticalOptions="Center"/>
                            <Label Text="{Binding ConnectionStatus}" 
                                   TextColor="White" 
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"
                                   HorizontalOptions="StartAndExpand"/>
                        </StackLayout>
                    </Frame>
                </StackLayout>
            </Frame>

            <!-- Measurement Form -->
            <Frame Style="{StaticResource CardFrame}">
                <StackLayout Spacing="15">
                    <Label Text="Параметры замера" 
                           FontAttributes="Bold" 
                           FontSize="16"
                           TextColor="{StaticResource TextPrimary}"/>

                    <!-- Velocity -->
                    <StackLayout Spacing="5">
                        <Label Text="Скорость вибрации" 
                               FontSize="14" 
                               TextColor="{StaticResource TextSecondary}"/>
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Entry Text="{Binding Velocity}" 
                                   Keyboard="Numeric" 
                                   Style="{StaticResource FormEntry}"
                                   HorizontalOptions="FillAndExpand"
                                   Placeholder="0.00"/>
                            <Label Text="мм/с" 
                                   VerticalOptions="Center" 
                                   TextColor="{StaticResource TextSecondary}"
                                   FontSize="14"/>
                        </StackLayout>
                    </StackLayout>

                    <!-- Temperature -->
                    <StackLayout Spacing="5">
                        <Label Text="Температура" 
                               FontSize="14" 
                               TextColor="{StaticResource TextSecondary}"/>
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Entry Text="{Binding Temperature}" 
                                   Keyboard="Numeric" 
                                   Style="{StaticResource FormEntry}"
                                   HorizontalOptions="FillAndExpand"
                                   Placeholder="0.00"/>
                            <Label Text="°C" 
                                   VerticalOptions="Center" 
                                   TextColor="{StaticResource TextSecondary}"
                                   FontSize="14"/>
                        </StackLayout>
                    </StackLayout>

                    <!-- Acceleration -->
                    <StackLayout Spacing="5">
                        <Label Text="Ускорение" 
                               FontSize="14" 
                               TextColor="{StaticResource TextSecondary}"/>
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Entry Text="{Binding Acceleration}" 
                                   Keyboard="Numeric" 
                                   Style="{StaticResource FormEntry}"
                                   HorizontalOptions="FillAndExpand"
                                   Placeholder="0.00"/>
                            <Label Text="м/с²" 
                                   VerticalOptions="Center" 
                                   TextColor="{StaticResource TextSecondary}"
                                   FontSize="14"/>
                        </StackLayout>
                    </StackLayout>

                    <!-- Kurtosis -->
                    <StackLayout Spacing="5">
                        <Label Text="Куртозис" 
                               FontSize="14" 
                               TextColor="{StaticResource TextSecondary}"/>
                        <Entry Text="{Binding Kurtosis}" 
                               Keyboard="Numeric" 
                               Style="{StaticResource FormEntry}"
                               Placeholder="0.00"/>
                    </StackLayout>
                </StackLayout>
            </Frame>

            <!-- Action Buttons -->
            <Frame Style="{StaticResource CardFrame}">
                <StackLayout Spacing="12">
                    <Button Text="💾 Сохранить замер" 
                            Command="{Binding SaveMeasurementCommand}"
                            Style="{StaticResource SuccessButton}"/>

                    <Button Text="🗑️ Очистить форму" 
                            Command="{Binding ClearFormCommand}"
                            Style="{StaticResource OutlineButton}"/>
                </StackLayout>
            </Frame>

            <!-- Vibrometer Controls -->
            <Frame Style="{StaticResource CardFrame}" IsVisible="{Binding CanUseVibrometer}">
                <StackLayout Spacing="15">
                    <Label Text="🔧 Управление виброметром" 
                           FontAttributes="Bold" 
                           FontSize="16"
                           TextColor="{StaticResource TextPrimary}"/>

                    <StackLayout Orientation="Horizontal" HorizontalOptions="Center" Spacing="15">
                        <Button Text="▶️ Запуск опроса" 
                                Command="{Binding StartPollingCommand}"
                                IsEnabled="{Binding IsPolling, Converter={StaticResource InverseBooleanConverter}}"
                                Style="{StaticResource PrimaryButton}"
                                WidthRequest="150"/>

                        <Button Text="⏹️ Остановка опроса" 
                                Command="{Binding StopPollingCommand}"
                                IsEnabled="{Binding IsPolling}"
                                Style="{StaticResource DangerButton}"
                                WidthRequest="150"/>
                    </StackLayout>

                    <!-- Polling Indicator -->
                    <StackLayout Spacing="10" IsVisible="{Binding IsPolling}">
                        <ActivityIndicator IsRunning="True" 
                                         Color="{StaticResource PrimaryColor}"
                                         HorizontalOptions="Center"
                                         HeightRequest="30" 
                                         WidthRequest="30"/>
                        <Label Text="Идет опрос виброметра..." 
                               HorizontalOptions="Center"
                               TextColor="{StaticResource SuccessColor}"
                               FontAttributes="Italic"/>
                    </StackLayout>
                </StackLayout>
            </Frame>

            <!-- Latest Measurement -->
            <Frame Style="{StaticResource CardFrame}" IsVisible="{Binding LatestMeasurement.HasData}">
                <StackLayout Spacing="12">
                    <Label Text="📈 Последний замер" 
                           FontAttributes="Bold" 
                           FontSize="16"
                           TextColor="{StaticResource TextPrimary}"/>

                    <Grid ColumnSpacing="10" RowSpacing="8">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Label Grid.Row="0" Grid.Column="0" Text="Время:" TextColor="{StaticResource TextSecondary}"/>
                        <Label Grid.Row="0" Grid.Column="1" Text="{Binding LatestMeasurement.MeasurementTime, StringFormat='{0:dd.MM.yyyy HH:mm}'}" FontAttributes="Bold"/>

                        <Label Grid.Row="1" Grid.Column="0" Text="Скорость:" TextColor="{StaticResource TextSecondary}"/>
                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding LatestMeasurement.Velocity, StringFormat='{0:F2} мм/с'}" FontAttributes="Bold"/>

                        <Label Grid.Row="2" Grid.Column="0" Text="Температура:" TextColor="{StaticResource TextSecondary}"/>
                        <Label Grid.Row="2" Grid.Column="1" Text="{Binding LatestMeasurement.Temperature, StringFormat='{0:F2} °C'}" FontAttributes="Bold"/>

                        <Label Grid.Row="3" Grid.Column="0" Text="Ускорение:" TextColor="{StaticResource TextSecondary}"/>
                        <Label Grid.Row="3" Grid.Column="1" Text="{Binding LatestMeasurement.Acceleration, StringFormat='{0:F2} м/с²'}" FontAttributes="Bold"/>

                        <Label Grid.Row="4" Grid.Column="0" Text="Куртозис:" TextColor="{StaticResource TextSecondary}"/>
                        <Label Grid.Row="4" Grid.Column="1" Text="{Binding LatestMeasurement.Kurtosis, StringFormat='{0:F2}'}" FontAttributes="Bold"/>

                        <Label Grid.Row="5" Grid.Column="0" Text="Устройство:" TextColor="{StaticResource TextSecondary}"/>
                        <Label Grid.Row="5" Grid.Column="1" Text="{Binding LatestMeasurement.DeviceId}" FontAttributes="Bold"/>
                    </Grid>
                </StackLayout>
            </Frame>
        </StackLayout>
    </ScrollView>
</ContentPage>